<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Merge example vignettes | ensemblemerge package documentation</title>
  <meta name="description" content="This is a reference for the ensemblemerge package for scRNAseq integration." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Merge example vignettes | ensemblemerge package documentation" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a reference for the ensemblemerge package for scRNAseq integration." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Merge example vignettes | ensemblemerge package documentation" />
  
  <meta name="twitter:description" content="This is a reference for the ensemblemerge package for scRNAseq integration." />
  

<meta name="author" content="Erik Skie" />


<meta name="date" content="2021-03-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="functions.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">ensemblemerge</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Package Information</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#description"><i class="fa fa-check"></i><b>1.1</b> Description</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="index.html"><a href="index.html#quick-start-guide"><i class="fa fa-check"></i><b>1.1.1</b> Quick Start Guide</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i><b>1.2</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="merge-example-vignettes.html"><a href="merge-example-vignettes.html"><i class="fa fa-check"></i><b>2</b> Merge example vignettes</a>
<ul>
<li class="chapter" data-level="2.1" data-path="merge-example-vignettes.html"><a href="merge-example-vignettes.html#processing-data-without-merging-batches"><i class="fa fa-check"></i><b>2.1</b> Processing data without merging batches</a></li>
<li class="chapter" data-level="2.2" data-path="merge-example-vignettes.html"><a href="merge-example-vignettes.html#merging-with-seurat"><i class="fa fa-check"></i><b>2.2</b> Merging with Seurat</a></li>
<li class="chapter" data-level="2.3" data-path="merge-example-vignettes.html"><a href="merge-example-vignettes.html#merging-with-bbknn"><i class="fa fa-check"></i><b>2.3</b> Merging with bbknn</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>3</b> functions</a>
<ul>
<li class="chapter" data-level="3.1" data-path="functions.html"><a href="functions.html#setparams"><i class="fa fa-check"></i><b>3.1</b> setParams()</a></li>
<li class="chapter" data-level="3.2" data-path="functions.html"><a href="functions.html#merge"><i class="fa fa-check"></i><b>3.2</b> Merge()</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="classes.html"><a href="classes.html"><i class="fa fa-check"></i><b>4</b> classes</a>
<ul>
<li class="chapter" data-level="4.1" data-path="classes.html"><a href="classes.html#uncorrectedparams"><i class="fa fa-check"></i><b>4.1</b> UncorrectedParams</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">ensemblemerge package documentation</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="merge-example-vignettes" class="section level1" number="2">
<h1><span class="header-section-number">Chapter 2</span> Merge example vignettes</h1>
<p>For more information on specific function parameters and class structures, see sections <a href="functions.html#functions">3</a> and <a href="classes.html#classes">4</a> respectively. This chapter covers basic vignettes of different integration methods using the example dataset provided as a SingleCellExperiment Object <a href="&#39;https://s3.msi.umn.edu/skiex003/datasets/dataset=JC_benchmark_scRNAseq_version=2021219a/dataset_4.rds&#39;">here</a>.</p>
<div id="processing-data-without-merging-batches" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Processing data without merging batches</h2>
<p>The following work flow is for processing data without performing batch correction. This can be done to prepare your data for downstream visualization without having to manually perform normalizing and scaling.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="merge-example-vignettes.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ensemblemerge)</span>
<span id="cb5-2"><a href="merge-example-vignettes.html#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="merge-example-vignettes.html#cb5-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">=</span> <span class="fu">setParams</span>(<span class="at">method =</span> <span class="st">&quot;Uncorrected&quot;</span>, <span class="at">batch =</span> <span class="st">&quot;batchlb&quot;</span>) <span class="co">#any additional processing argument can be added here, see chapter 3: classes</span></span>
<span id="cb5-4"><a href="merge-example-vignettes.html#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="merge-example-vignettes.html#cb5-5" aria-hidden="true" tabindex="-1"></a>uncorrected <span class="ot">=</span> <span class="fu">Merge</span>(params, dendrites)</span></code></pre></div>
<p><code>uncorrected</code> contains normalized and scaled read counts and a PCA reduction. generating a UMAP reduction can be done by the following.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="merge-example-vignettes.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Seurat)</span>
<span id="cb6-2"><a href="merge-example-vignettes.html#cb6-2" aria-hidden="true" tabindex="-1"></a>uncorrected <span class="ot">=</span> <span class="fu">as.Seurat</span>(uncorrected, <span class="at">counts =</span> <span class="st">&quot;counts&quot;</span>, <span class="at">data =</span> <span class="st">&quot;logcounts&quot;</span>)</span>
<span id="cb6-3"><a href="merge-example-vignettes.html#cb6-3" aria-hidden="true" tabindex="-1"></a>uncorrected <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;PCA&quot;</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">seed.use =</span> <span class="dv">1</span>)</span>
<span id="cb6-4"><a href="merge-example-vignettes.html#cb6-4" aria-hidden="true" tabindex="-1"></a>uncorrected <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&#39;umap&#39;</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-5"><a href="merge-example-vignettes.html#cb6-5" aria-hidden="true" tabindex="-1"></a>uncorrected <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(uncorrected, <span class="at">algorithm =</span> <span class="dv">3</span>, <span class="at">resolution =</span> <span class="fl">0.01</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-6"><a href="merge-example-vignettes.html#cb6-6" aria-hidden="true" tabindex="-1"></a>uncorrected<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">Idents</span>(uncorrected)</span></code></pre></div>
<p>Visualize the UMAP.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="merge-example-vignettes.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;batchlb&quot;</span></span>
<span id="cb7-2"><a href="merge-example-vignettes.html#cb7-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Batch&quot;</span>)</span>
<span id="cb7-3"><a href="merge-example-vignettes.html#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;CellType&quot;</span></span>
<span id="cb7-4"><a href="merge-example-vignettes.html#cb7-4" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Cell Type&quot;</span>)</span>
<span id="cb7-5"><a href="merge-example-vignettes.html#cb7-5" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-9"></span>
<img src="_book/ensemblemerge_files/images/uncorrected_batch.png" alt="Uncorrected UMAP of single cell data by batch and cell type" width="1200" height="80%" />
<p class="caption">
Figure 2.1: Uncorrected UMAP of single cell data by batch and cell type
</p>
</div>
</div>
<div id="merging-with-seurat" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Merging with Seurat</h2>
<p>This workflow is for integrating batches with the <a href="&#39;https://satijalab.org/seurat/articles/integration_introduction.html&#39;">Seurat V3</a> batch correction method.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="merge-example-vignettes.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ensemblemerge)</span>
<span id="cb8-2"><a href="merge-example-vignettes.html#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="merge-example-vignettes.html#cb8-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">=</span> <span class="fu">setParams</span>(<span class="at">method =</span> <span class="st">&quot;Seurat&quot;</span>, <span class="at">batch =</span> <span class="st">&quot;batchlb&quot;</span>) <span class="co">#any additional processing argument can be added here, see chapter 3: classes</span></span>
<span id="cb8-4"><a href="merge-example-vignettes.html#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="merge-example-vignettes.html#cb8-5" aria-hidden="true" tabindex="-1"></a>seurat_integrate <span class="ot">=</span> <span class="fu">Merge</span>(params, dendrites)</span></code></pre></div>
<p><code>seurat_integrate</code> contains normalized and scaled read counts and a PCA reduction. generating a UMAP reduction can be done by the following.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="merge-example-vignettes.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Seurat)</span>
<span id="cb9-2"><a href="merge-example-vignettes.html#cb9-2" aria-hidden="true" tabindex="-1"></a>seurat_integrate <span class="ot">=</span> <span class="fu">as.Seurat</span>(seurat_integrate, <span class="at">counts =</span> <span class="st">&quot;logcounts&quot;</span>, <span class="at">data =</span> <span class="st">&quot;logcounts&quot;</span>)</span>
<span id="cb9-3"><a href="merge-example-vignettes.html#cb9-3" aria-hidden="true" tabindex="-1"></a>seurat_integrate <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(seurat_integrate, <span class="at">reduction =</span> <span class="st">&quot;PCA&quot;</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">seed.use =</span> <span class="dv">1</span>)</span>
<span id="cb9-4"><a href="merge-example-vignettes.html#cb9-4" aria-hidden="true" tabindex="-1"></a>seurat_integrate <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(seurat_integrate, <span class="at">reduction =</span> <span class="st">&#39;umap&#39;</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-5"><a href="merge-example-vignettes.html#cb9-5" aria-hidden="true" tabindex="-1"></a>seurat_integrate <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(seurat_integrate, <span class="at">algorithm =</span> <span class="dv">3</span>, <span class="at">resolution =</span> <span class="fl">0.01</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-6"><a href="merge-example-vignettes.html#cb9-6" aria-hidden="true" tabindex="-1"></a>seurat_integrate<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">Idents</span>(seurat_integrate)</span></code></pre></div>
<p>Visualize the UMAP (<em>including the uncorrected data for reference</em>).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="merge-example-vignettes.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;batchlb&quot;</span></span>
<span id="cb10-2"><a href="merge-example-vignettes.html#cb10-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Batch&quot;</span>)</span>
<span id="cb10-3"><a href="merge-example-vignettes.html#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;CellType&quot;</span></span>
<span id="cb10-4"><a href="merge-example-vignettes.html#cb10-4" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Cell Type&quot;</span>)</span>
<span id="cb10-5"><a href="merge-example-vignettes.html#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(seurat_integrate) <span class="ot">=</span> <span class="st">&quot;batchlb&quot;</span></span>
<span id="cb10-6"><a href="merge-example-vignettes.html#cb10-6" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(seurat_integrate, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Corrected Batch&quot;</span>)</span>
<span id="cb10-7"><a href="merge-example-vignettes.html#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(seurat_integrate) <span class="ot">=</span> <span class="st">&quot;CellType&quot;</span></span>
<span id="cb10-8"><a href="merge-example-vignettes.html#cb10-8" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(seurat_integrate, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Corrected Cell Type&quot;</span>)</span>
<span id="cb10-9"><a href="merge-example-vignettes.html#cb10-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> p4</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-13"></span>
<img src="_book/ensemblemerge_files/images/seurat_integrate.png" alt="Seurat V3 corrected UMAP of single cell data by batch and cell type" width="1200" height="80%" />
<p class="caption">
Figure 2.2: Seurat V3 corrected UMAP of single cell data by batch and cell type
</p>
</div>
</div>
<div id="merging-with-bbknn" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Merging with bbknn</h2>
<p>This workflow is for integrating batches with the <a href="&#39;https://github.com/Teichlab/bbknn&#39;">bbknn</a> batch correction method.</p>
<p>To take full advantage of all available features of bbknn integration, install the following packages.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="merge-example-vignettes.html#cb11-1" aria-hidden="true" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;rstudio/reticulate&quot;</span>) <span class="co">#increases available memory</span></span>
<span id="cb11-2"><a href="merge-example-vignettes.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="st">&quot;pip3 install pynndescent&quot;</span>) <span class="co">#optimizes dimension reduction</span></span>
<span id="cb11-3"><a href="merge-example-vignettes.html#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="st">&quot;pip3 install leidenalg&quot;</span>) <span class="co">#optional clustering algorithm that improves bbknn performance</span></span></code></pre></div>
<p>Perform default bbknn integration.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="merge-example-vignettes.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ensemblemerge)</span>
<span id="cb12-2"><a href="merge-example-vignettes.html#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="merge-example-vignettes.html#cb12-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">=</span> <span class="fu">setParams</span>(<span class="at">method =</span> <span class="st">&quot;BBKNN&quot;</span>, <span class="at">batch =</span> <span class="st">&quot;batchlb&quot;</span>, <span class="at">return =</span> <span class="st">&quot;Seurat&quot;</span>) <span class="co">#any additional processing argument can be added here, see chapter 3: classes</span></span>
<span id="cb12-4"><a href="merge-example-vignettes.html#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="merge-example-vignettes.html#cb12-5" aria-hidden="true" tabindex="-1"></a>bbknn_integrate <span class="ot">=</span> <span class="fu">Merge</span>(params, dendrites)</span></code></pre></div>
<p><code>bbknn_integrate</code> contains normalized and scaled read counts and a <em>bbknn</em> neighbor graph. generating a UMAP reduction can be done by the following</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="merge-example-vignettes.html#cb13-1" aria-hidden="true" tabindex="-1"></a>bbknn_integrate <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(bbknn_integrate, <span class="at">nn.name =</span> <span class="st">&quot;bbknn&quot;</span>)</span></code></pre></div>
<p>Visualize the UMAP (<em>including the uncorrected data for reference</em>).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="merge-example-vignettes.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;batchlb&quot;</span></span>
<span id="cb14-2"><a href="merge-example-vignettes.html#cb14-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Batch&quot;</span>)</span>
<span id="cb14-3"><a href="merge-example-vignettes.html#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;CellType&quot;</span></span>
<span id="cb14-4"><a href="merge-example-vignettes.html#cb14-4" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Cell Type&quot;</span>)</span>
<span id="cb14-5"><a href="merge-example-vignettes.html#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(bbknn_integrate) <span class="ot">=</span> <span class="st">&quot;batchlb&quot;</span></span>
<span id="cb14-6"><a href="merge-example-vignettes.html#cb14-6" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(bbknn_integrate, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Corrected Batch&quot;</span>)</span>
<span id="cb14-7"><a href="merge-example-vignettes.html#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(bbknn_integrate) <span class="ot">=</span> <span class="st">&quot;CellType&quot;</span></span>
<span id="cb14-8"><a href="merge-example-vignettes.html#cb14-8" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(bbknn_integrate, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Corrected Cell Type&quot;</span>)</span>
<span id="cb14-9"><a href="merge-example-vignettes.html#cb14-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> p4</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-18"></span>
<img src="_book/ensemblemerge_files/images/bbknn_default.png" alt="bbknn corrected UMAP of single cell data by batch and cell type" width="1200" height="80%" />
<p class="caption">
Figure 2.3: bbknn corrected UMAP of single cell data by batch and cell type
</p>
</div>
<p>By default, bbknn integration uses <a href="https://science.sciencemag.org/content/367/6480/eaay3224.abstract">ridge regression</a>, which can improve integration by combining both biological and technical effects. This step can be removed by</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="merge-example-vignettes.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ensemblemerge)</span>
<span id="cb15-2"><a href="merge-example-vignettes.html#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="merge-example-vignettes.html#cb15-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">=</span> <span class="fu">setParams</span>(<span class="at">method =</span> <span class="st">&quot;BBKNN&quot;</span>, <span class="at">batch =</span> <span class="st">&quot;batchlb&quot;</span>, <span class="at">ridge_regress =</span> <span class="cn">FALSE</span>) <span class="co">#any additional processing argument can be added here, see chapter 3: classes</span></span>
<span id="cb15-4"><a href="merge-example-vignettes.html#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="merge-example-vignettes.html#cb15-5" aria-hidden="true" tabindex="-1"></a>bbknn_integrate <span class="ot">=</span> <span class="fu">Merge</span>(params, dendrites)</span></code></pre></div>
<p><code>bbknn_integrate</code> contains normalized and scaled read counts and a <em>bbknn</em> neighbor graph. generating a UMAP reduction can be done by the following</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="merge-example-vignettes.html#cb16-1" aria-hidden="true" tabindex="-1"></a>bbknn_integrate <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(bbknn_integrate, <span class="at">nn.name =</span> <span class="st">&quot;bbknn&quot;</span>)</span></code></pre></div>
<p>Visualize the UMAP (<em>including the uncorrected data for reference</em>).</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="merge-example-vignettes.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;batchlb&quot;</span></span>
<span id="cb17-2"><a href="merge-example-vignettes.html#cb17-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Batch&quot;</span>)</span>
<span id="cb17-3"><a href="merge-example-vignettes.html#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;CellType&quot;</span></span>
<span id="cb17-4"><a href="merge-example-vignettes.html#cb17-4" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Cell Type&quot;</span>)</span>
<span id="cb17-5"><a href="merge-example-vignettes.html#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(bbknn_integrate) <span class="ot">=</span> <span class="st">&quot;batchlb&quot;</span></span>
<span id="cb17-6"><a href="merge-example-vignettes.html#cb17-6" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(bbknn_integrate, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Corrected Batch&quot;</span>)</span>
<span id="cb17-7"><a href="merge-example-vignettes.html#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(bbknn_integrate) <span class="ot">=</span> <span class="st">&quot;CellType&quot;</span></span>
<span id="cb17-8"><a href="merge-example-vignettes.html#cb17-8" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(bbknn_integrate, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Corrected Cell Type&quot;</span>)</span>
<span id="cb17-9"><a href="merge-example-vignettes.html#cb17-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> p4</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-22"></span>
<img src="_book/ensemblemerge_files/images/bbknn_ridge_regress_false.png" alt="bbknn without ridge regression corrected UMAP of single cell data by batch and cell type" width="1200" height="80%" />
<p class="caption">
Figure 2.4: bbknn without ridge regression corrected UMAP of single cell data by batch and cell type
</p>
</div>
<p>which can improve performance.</p>
<p>If you have additional cell data you would like to support the integration (i.e.Â cell type), you can add that by the following</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="merge-example-vignettes.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ensemblemerge)</span>
<span id="cb18-2"><a href="merge-example-vignettes.html#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="merge-example-vignettes.html#cb18-3" aria-hidden="true" tabindex="-1"></a>params <span class="ot">=</span> <span class="fu">setParams</span>(<span class="at">method =</span> <span class="st">&quot;BBKNN&quot;</span>, <span class="at">batch =</span> <span class="st">&quot;batchlb&quot;</span>, <span class="at">confounder_key =</span> <span class="st">&quot;CellType&quot;</span>) <span class="co">#any additional processing argument can be added here, see chapter 3: classes</span></span>
<span id="cb18-4"><a href="merge-example-vignettes.html#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="merge-example-vignettes.html#cb18-5" aria-hidden="true" tabindex="-1"></a>bbknn_integrate <span class="ot">=</span> <span class="fu">Merge</span>(params, dendrites)</span></code></pre></div>
<p><code>bbknn_integrate</code> contains normalized and scaled read counts and a <em>bbknn</em> neighbor graph. generating a UMAP reduction can be done by the following</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="merge-example-vignettes.html#cb19-1" aria-hidden="true" tabindex="-1"></a>bbknn_integrate <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(bbknn_integrate, <span class="at">nn.name =</span> <span class="st">&quot;bbknn&quot;</span>)</span></code></pre></div>
<p>Visualize the UMAP (<em>including the uncorrected data for reference</em>).</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="merge-example-vignettes.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;batchlb&quot;</span></span>
<span id="cb20-2"><a href="merge-example-vignettes.html#cb20-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Batch&quot;</span>)</span>
<span id="cb20-3"><a href="merge-example-vignettes.html#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(uncorrected) <span class="ot">=</span> <span class="st">&quot;CellType&quot;</span></span>
<span id="cb20-4"><a href="merge-example-vignettes.html#cb20-4" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(uncorrected, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Uncorrected Cell Type&quot;</span>)</span>
<span id="cb20-5"><a href="merge-example-vignettes.html#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(bbknn_integrate) <span class="ot">=</span> <span class="st">&quot;batchlb&quot;</span></span>
<span id="cb20-6"><a href="merge-example-vignettes.html#cb20-6" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(bbknn_integrate, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Corrected Batch&quot;</span>)</span>
<span id="cb20-7"><a href="merge-example-vignettes.html#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(bbknn_integrate) <span class="ot">=</span> <span class="st">&quot;CellType&quot;</span></span>
<span id="cb20-8"><a href="merge-example-vignettes.html#cb20-8" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(bbknn_integrate, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">pt.size =</span> <span class="fl">0.5</span>, <span class="at">shuffle =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">&quot;Corrected Cell Type&quot;</span>)</span>
<span id="cb20-9"><a href="merge-example-vignettes.html#cb20-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> p4</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-26"></span>
<img src="_book/ensemblemerge_files/images/bbknn_cell_type_confound.png" alt="bbknn with cell type confound corrected UMAP of single cell data by batch and cell type" width="1200" height="80%" />
<p class="caption">
Figure 2.5: bbknn with cell type confound corrected UMAP of single cell data by batch and cell type
</p>
</div>
<p>which can improve the quality of integration.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="functions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["ensemblemerge.pdf", "ensemblemerge.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
